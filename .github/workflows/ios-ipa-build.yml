name: iOS-ipa-build

on:
  push:
    branches: [ main ]
    paths:
      - 'mobile/**'
      - '.github/workflows/ios-ipa-build.yml'

jobs:
  build-ios:
    name: üéâ Build & Release iOS IPA
    runs-on: macos-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      - name: Flutter doctor
        run: flutter doctor -v

      - name: Extract version from pubspec.yaml
        id: version
        run: |
          cd mobile
          LINE=$(grep '^version:' pubspec.yaml)
          VERSION=$(echo $LINE | sed 's/version: //; s/+.*//')
          BUILD=$(echo $LINE | sed 's/.*+//')
          NEW_BUILD=$((BUILD + 1))
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build=$BUILD" >> $GITHUB_OUTPUT
          echo "new_build=$NEW_BUILD" >> $GITHUB_OUTPUT
        shell: bash

      - name: Bump build number in pubspec.yaml
        run: |
          cd mobile
          sed -i.bak "s/^version: .*/version: ${{ steps.version.outputs.version }}+${{ steps.version.outputs.new_build }}/" pubspec.yaml
          rm pubspec.yaml.bak
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pubspec.yaml
          git commit -m "‚¨ÜÔ∏è Bump iOS build number to ${{ steps.version.outputs.new_build }}"
          for i in {1..5}; do
            git pull --rebase origin main && git push && break || sleep 2
          done
        shell: bash

      - name: Clean Flutter
        run: |
          cd mobile
          flutter clean

      - name: Get Flutter dependencies
        run: |
          cd mobile
          flutter pub get

      - name: Install CocoaPods dependencies
        run: |
          cd mobile/ios
          pod repo update
          pod install

      - name: Build iOS IPA (no codesign)
        run: |
          cd mobile
          flutter build ipa --release --no-codesign

      - name: Verify IPA location
        run: |
          cd mobile
          ls -la build/ios/ipa/ || echo "IPA directory not found"
          ls -la build/ios/iphoneos/ || echo "iphoneos directory not found"

      - name: Prepare IPA
        run: |
          cd mobile/build/ios/iphoneos
          mkdir -p Payload
          cp -r Runner.app Payload/
          zip -qq -r -9 FlutterIpaExport.ipa Payload

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FlutterIpaExport-${{ steps.version.outputs.version }}+${{ steps.version.outputs.new_build }}
          path: mobile/build/ios/iphoneos/FlutterIpaExport.ipa

      - name: Upload IPA to GitHub Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: mobile/build/ios/iphoneos/FlutterIpaExport.ipa
          tag: ios-v${{ steps.version.outputs.version }}+${{ steps.version.outputs.new_build }}
          release_name: "iOS v${{ steps.version.outputs.version }}+${{ steps.version.outputs.new_build }}"
          body: "Auto-generated release for iOS build v${{ steps.version.outputs.version }}+${{ steps.version.outputs.new_build }}"
          overwrite: true
          make_latest: true
